<!DOCTYPE html>
<html lang="en"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" type="text/css" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}" />
</head>
<body>
<div>
  <button id="connect">Connect</button>
  <button id="disconnect" disabled="disabled">Disconnect</button>
</div>
<div>
  <input type="text" id="name" placeholder="Your Name" />
  <button id="send" disabled="disabled">Send</button>
  <div id="response"></div>
</div>
</body>
<script th:src="@{/stomp.js}" src="/stomp.js"></script>
<script th:inline="javascript">
  /*<![CDATA[*/
  var HelloStomp = function () {
    this.connectButton = document.getElementById('connect');
    this.disconnectButton = document.getElementById('disconnect');
    this.sendButton = document.getElementById('send');

    this.connectButton.addEventListener('click', this.connect.bind(this));
    this.disconnectButton.addEventListener('click', this.disconnect.bind(this));
    this.sendButton.addEventListener('click', this.sendName.bind(this));
  };

  /**
   * エンドポイントへの接続処理
   */
  HelloStomp.prototype.connect = function () {
    var socket = new WebSocket(/*[[${endpointUrl}]]*/);
    this.stompClient = Stomp.over(socket); // WebSocketを使ったStompクライアントを作成
    this.stompClient.connect({}, this.onConnected.bind(this)); // エンドポイントに接続し、接続した際のコールバックを登録
  };

  /**
   * エンドポイントへ接続したときの処理
   */
  HelloStomp.prototype.onConnected = function (frame) {
    console.log('Connected: ' + frame);
    // メッセージを購読し、コールバック処理を登録
    this.stompClient.subscribe(/*[[${subscribePath}]]*/, this.onSubscribeGreeting.bind(this));
    this.setConnected(true);
  };

  /**
   * subscribeしたメッセージを受信したときの処理
   */
  HelloStomp.prototype.onSubscribeGreeting = function (message) {
    var response = document.getElementById('response');
    var p = document.createElement('p');
    p.appendChild(document.createTextNode(message.body));
    response.insertBefore(p, response.children[0]);
  };

  /**
   * メッセージ送信処理
   */
  HelloStomp.prototype.sendName = function () {
    var name = document.getElementById('name').value;
    this.stompClient.send(/*[[${messagePath}]]*/, {}, name);
  };

  HelloStomp.prototype.disconnect = function () {
    if (this.stompClient) {
      this.stompClient.disconnect();
      this.stompClient = null;
    }
    this.setConnected(false);
  };

  HelloStomp.prototype.setConnected = function (connected) {
    this.connectButton.disabled = connected;
    this.disconnectButton.disabled = !connected;
    this.sendButton.disabled = !connected;
  };

  new HelloStomp();
  /*]]>*/
</script>
</html>
